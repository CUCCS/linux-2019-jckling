## 开机自启动项管理

### 实验要求

- systemd 操作全程录像

### 实验环境

Ubuntu18.04 Server
- 网卡：NAT、Host-Only
- 镜像：ubuntu-18.04.1-server-amd64.iso

Windows 10
- git bash (ssh)

### systemd 操作录像

Start

<a href="https://asciinema.org/a/Ibzc1rUJB5pojYrhdevlO3XGp?autoplay=1" target="_blank"><img src="https://asciinema.org/a/Ibzc1rUJB5pojYrhdevlO3XGp.svg" width="555" /></a>


Unit

<a href="https://asciinema.org/a/bzTr123XIPh1wgsi9QcATwcDY?autoplay=1" target="_blank"><img src="https://asciinema.org/a/bzTr123XIPh1wgsi9QcATwcDY.svg" width="555" /></a>


Strat/Stop/Restart

<a href="https://asciinema.org/a/pWn1GaZBA2Gaee2XPrWfaNEdy?autoplay=1" target="_blank"><img src="https://asciinema.org/a/pWn1GaZBA2Gaee2XPrWfaNEdy.svg" width="555" /></a>


Unit files

<a href="https://asciinema.org/a/rJZ0JxWPKAx4Kil7Bd8QyUj22?autoplay=1" target="_blank"><img src="https://asciinema.org/a/rJZ0JxWPKAx4Kil7Bd8QyUj22.svg" width="555" /></a>


Journalctl

<a href="https://asciinema.org/a/iZh4QWtOVilbdENRl88wpCS7K?autoplay=1" target="_blank"><img src="https://asciinema.org/a/iZh4QWtOVilbdENRl88wpCS7K.svg" width="555" /></a>

### 自查清单

##### 1. 如何添加一个用户并使其具备sudo执行程序的权限？
##### 2. 如何将一个用户添加到一个用户组？

```bash
# 添加普通用户
sudo adduser cuc

# 切换到该用户
su cuc

# 无法执行 sudo
sudo su -

# 退出
exit

# 添加到 sudo 组
sudo adduser cuc sudo

# 切换到该用户
su cuc

# 可以执行 sudo
sudo su -
```

<a href="https://asciinema.org/a/dWUAqcwKpI59nmbV3JbsquxQw?autoplay=1" target="_blank"><img src="https://asciinema.org/a/dWUAqcwKpI59nmbV3JbsquxQw.svg" width="400" /></a>

##### 3. 如何查看当前系统的分区表和文件系统详细信息？

- 分区表：`sudo fdisk -l` 或 `sudo sfdisk -l` 或 `cfdisk`
- 文件系统信息：`df -a`

##### 4. 如何实现开机自动挂载Virtualbox的共享目录分区？

以 Ubuntu 16.04 桌面版为例：

使用设备-共享文件夹-添加共享文件夹（名为codes）
- [ ] 只读分配
- [x] 自动挂载  # 设置了也无法自动挂载，需进行配置（尝试自动挂载）
- [x] 固定分配

```bash
# 新建挂载目录
mkdir ~/shared

# 挂载文件夹
sudo mount -t vboxsf codes ~/shared

# 修改配置文件
sudo gedit /etc/fstab

# 修改模块
sudo gedit /etc/modules
```

- [Mounting VirtualBox shared folders on Ubuntu Server 16.04 LTS](https://gist.github.com/estorgio/1d679f962e8209f8a9232f7593683265)

##### 5. 基于LVM（逻辑分卷管理）的分区如何实现动态扩容和缩减容量？

使用 LVM2 工具集

```bash
# 逻辑卷信息
lvdisplay

# 缩容
lvreduce --size -1024m /dev/bogon-vg/root

# 扩容
lvextend --size +1024m /dev/bogon-vg/root

# 更改大小
lvresize --size +1024m /dev/bogon-vg/root
```

##### 6. 如何通过systemd设置实现在网络连通时运行一个指定脚本，在网络断开时运行另一个脚本？

网络连通时的脚本服务配置

```bash
[Unit]
Description=Network up
Wants=network-online.target
After=network-online.target network.target

[Service]
Type=oneshot
ExecStart=/bin/echo "start"

[Install]
WantedBy=multi-user.target
```

网络断开时（推测）可以直接在 /lib/systemd/system/systemd-networkd-wait-online.service 的配置文件中添加 `ExecStop=script` 选项。 


##### 7. 如何通过systemd设置实现一个脚本在任何情况下被杀死之后会立即重新启动？实现杀不死？

编写脚本文件并赋予可执行权限

```bash
# 编辑脚本
vi mybash

# 以下为脚本内容
#!/bin/bash
echo "mybash is running"
```

编写配置文件

```bash
# 创建并编辑配置文件
sudo vi /lib/systemd/system/mybash.service

# 以下为配置文件内容
[Unit]
Description=My Script

[Service]
Type=forking
ExecStart=/usr/bin/mybash
ExecStop=/usr/bin/mybash
Restart=always
RestartSec=5
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```

重新加载并查看结果

```bash
# 重新加载配置文件
systemctl daemon-reload

# 启动该服务
systemctl start mybash.service

# 通过日志查看输出
journalctl -f

# 尝试停止服务，还真的停了emmmmm
systemctl stop mybash.service

# 再次查看日志
journalctl -n
```

![](log.png)

##### 8. 其他

开机自启动项管理
- `systemctl list-unit-files | grep enabled`

配置每天自动安装更新
- `sudo dpkg-reconfigure unattended-upgrades`

```bash
# 编辑配置文件启用自动更新
vi /etc/apt/apt.conf.d/02periodic

# 以下为设置每天更新的配置信息
# Run the "unattended-upgrade" security upgrade script
# every n-days (0=disabled)
# Requires the package "unattended-upgrades" and will write
# a log in /var/log/unattended-upgrades
APT::Periodic::Unattended-Upgrade "1";
```

### 疑问
1. 网络断开的条件配置，`Before=network-online.target` ？
2. **脚本杀死后重启** 这个题意我可能跑偏了，配置文件加上 `ExecStop=/bin/systemd start mybash.service` ？
3. 共享文件使用 Samba 不是更方便吗？

### 参阅
- [systemd - system and service manager](https://wiki.debian.org/systemd)
- [What is the SHA256 that comes on the sshd entry in auth.log](https://serverfault.com/questions/888281/what-is-the-sha256-that-comes-on-the-sshd-entry-in-auth-log)
- [LVM](https://wiki.debian.org/LVM)
- [UnattendedUpgrades](https://wiki.debian.org/UnattendedUpgrades)
- [Mounting VirtualBox shared folders on Ubuntu Server 16.04 LTS](https://gist.github.com/estorgio/1d679f962e8209f8a9232f7593683265)
- [How to write startup script for systemd](https://unix.stackexchange.com/questions/47695/how-to-write-startup-script-for-systemd)
- [Running Services After the Network is up](https://www.freedesktop.org/wiki/Software/systemd/NetworkTarget/)
- [Backup Utilities](https://help.ubuntu.com/community/BackupYourSystem#Backup_Utilities)